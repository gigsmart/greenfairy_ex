name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Run Claude Code Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Get the diff for the PR
          git diff origin/${{ github.base_ref }}...HEAD > pr_diff.txt

          # Run Claude Code to review the changes
          claude -p "Review this pull request diff for an Elixir GraphQL library called Absinthe.Object.

          Focus on:
          1. Code quality and Elixir best practices
          2. Potential bugs or edge cases
          3. Documentation completeness
          4. Test coverage suggestions
          5. Security considerations

          Provide actionable feedback. Be constructive and specific.

          Here's the diff:
          $(cat pr_diff.txt)" --output-format json > review_output.json || true

      - name: Post Review Comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let review = 'Claude Code Review could not be completed.';
            try {
              const output = fs.readFileSync('review_output.json', 'utf8');
              const parsed = JSON.parse(output);
              review = parsed.result || parsed.message || output;
            } catch (e) {
              console.log('Error parsing review output:', e);
              try {
                review = fs.readFileSync('review_output.json', 'utf8');
              } catch (e2) {
                console.log('Could not read review output');
              }
            }

            // Truncate if too long
            if (review.length > 65000) {
              review = review.substring(0, 65000) + '\n\n...(truncated)';
            }

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Claude Code Review\n\n${review}`
            });
